<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>공고 목록</title>
</head>
<body>

<h2>공고 목록</h2>
<ul id="list"></ul>

<script>
    // 1️⃣ 로그인 여부 확인
    fetch("/auth/me", {
        credentials: "include"
    })
    .then(res => res.json())
    .then(isLogin => {

        if (!isLogin) {
            alert("로그인이 필요합니다.");
            location.href = "/login.html";
            return;
        }

        // 2️⃣ DB 기준 공고 조회 (북마크 포함)
        fetch("/jobs", {
            credentials: "include"
        })
        .then(res => res.json())
        .then(data => {

            const list = document.getElementById("list");
            list.innerHTML = "";

            data.forEach(job => {

                const li = document.createElement("li");

                // 제목
                const title = document.createElement("span");
                title.innerText = job.title + " (" + job.company + ") ";
                li.appendChild(title);

                // 마감일
                if (job.deadline) {
                    const deadline = document.createElement("span");
                    deadline.innerText = " [마감: " + job.deadline + "] ";
                    li.appendChild(deadline);
                }

                // 북마크 버튼
                const btn = document.createElement("button");

                // 현재 북마크 상태 반영
                btn.innerText = job.bookmarked ? "★ 북마크됨" : "☆ 북마크";

                btn.onclick = () => {

                    fetch("/bookmark/" + encodeURIComponent(job.jobId), {
                        method: "POST",
                        credentials: "include"
                    })
                    .then(res => res.text())
                    .then(() => {

                        // 버튼 상태 즉시 변경
                        if (btn.innerText === "☆ 북마크") {
                            btn.innerText = "★ 북마크됨";
                        } else {
                            btn.innerText = "☆ 북마크";
                        }

                    })
                    .catch(() => {
                        alert("북마크 처리 실패");
                    });
                };

                li.appendChild(btn);
                list.appendChild(li);
            });
        });
    });
</script>

</body>
</html>
