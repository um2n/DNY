<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>공고 목록</title>
    <style>
        /* 간단한 스타일 추가 */
        li { margin-bottom: 10px; list-style: none; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        button { cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

<h2>공고 목록</h2>

<!-- 필터 및 검색 UI 추가 -->
<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
    <input type="text" id="keywordInput" placeholder="검색어 (예: 개발, 보안)" style="padding: 5px;">
    
    <select id="locationSelect" style="padding: 5px;">
        <option value="">지역 전체</option>
        <option value="서울">서울</option>
        <option value="경기">경기</option>
        <option value="인천">인천</option>
        <option value="대전">대전</option>
        <option value="대구">대구</option>
        <option value="부산">부산</option>
        <option value="광주">광주</option>
    </select>

    <select id="typeSelect" style="padding: 5px;">
        <option value="">채용구분 전체</option>
        <option value="신입">신입</option>
        <option value="인턴">인턴</option>
    </select>

    <select id="sortSelect" onchange="loadJobs(0)" style="padding: 5px;">
        <option value="createdAt,desc">최신 등록순</option>
        <option value="deadline,asc">마감 임박순</option>
    </select>

    <button onclick="loadJobs(0)" style="padding: 5px 15px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">검색</button>
</div>

<ul id="list">로드 중...</ul>

<!-- 페이징 버튼 추가 -->
<div id="pagination" style="margin-top: 20px;">
    <button id="prevBtn" onclick="changePage(-1)">이전</button>
    <span id="pageInfo">0 / 0</span>
    <button id="nextBtn" onclick="changePage(1)">다음</button>
</div>

<script>
    let currentPage = 0;
    let totalPages = 0;

    // 1️⃣ 로그인 여부 확인 및 공고 로드
    function loadJobs(page = 0) {
        currentPage = page;
        
        // 필터 값 읽기
        const keyword = document.getElementById("keywordInput").value;
        const location = document.getElementById("locationSelect").value;
        const jobType = document.getElementById("typeSelect").value;
        const sort = document.getElementById("sortSelect").value;
        
        // URL 파라미터 구성
        let url = `/jobs?page=${page}&size=10&sort=${sort}`;
        if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
        if (location) url += `&location=${encodeURIComponent(location)}`;
        if (jobType) url += `&jobType=${encodeURIComponent(jobType)}`;
        
        fetch(url, {
            credentials: "include"
        })
        .then(res => {
            if (res.status === 401) {
                alert("로그인이 필요합니다.");
                location.href = "/login.html";
                throw new Error("Unauthorized");
            }
            return res.json();
        })
        .then(response => {
            // ApiResponse 구조 반영
            if (!response.success) {
                alert(response.message);
                return;
            }

            const list = document.getElementById("list");
            list.innerHTML = "";

            // 페이징 객체에서 content 추출
            const pageData = response.data;
            const jobs = pageData.content;
            totalPages = pageData.page.totalPages;

            // 페이지 정보 업데이트
            document.getElementById("pageInfo").innerText = `${pageData.page.number + 1} / ${totalPages}`;
            document.getElementById("prevBtn").disabled = (pageData.page.number === 0);
            document.getElementById("nextBtn").disabled = (pageData.page.number + 1 >= totalPages);

            if (!jobs || jobs.length === 0) {
                list.innerHTML = "<li>표시할 공고가 없습니다.</li>";
                return;
            }

            jobs.forEach(job => {
                const li = document.createElement("li");

                const title = document.createElement("span");
                title.innerHTML = `<strong>${job.title}</strong> (${job.company})`;
                li.appendChild(title);

                if (job.deadline) {
                    const deadline = document.createElement("span");
                    deadline.innerText = ` [마감: ${job.deadline}] `;
                    li.appendChild(deadline);
                }

                const btn = document.createElement("button");
                updateButtonStyle(btn, job.bookmarked);

                btn.onclick = () => {
                    fetch("/bookmark/" + encodeURIComponent(job.jobId), {
                        method: "POST",
                        credentials: "include"
                    })
                    .then(res => res.json())
                    .then(response => {
                        alert(response.message);

                        if (response.success) {
                            if (response.message === "북마크 완료") {
                                updateButtonStyle(btn, true);
                            } else if (response.message === "북마크 취소") {
                                updateButtonStyle(btn, false);
                            }
                        }
                    })
                    .catch(() => {
                        alert("북마크 처리 중 오류가 발생했습니다.");
                    });
                };

                li.appendChild(btn);
                list.appendChild(li);
            });
        })
        .catch(err => {
            if (err.message !== "Unauthorized") {
                console.error("공고 로딩 실패:", err);
                document.getElementById("list").innerHTML = "공고를 불러오는 데 실패했습니다.";
            }
        });
    }

    function updateButtonStyle(button, isBookmarked) {
        if (isBookmarked) {
            button.innerText = "★ 북마크됨";
            button.style.backgroundColor = "#ffd700";
            button.style.color = "black";
        } else {
            button.innerText = "☆ 북마크";
            button.style.backgroundColor = "";
            button.style.color = "";
        }
    }

    function changePage(offset) {
        const newPage = currentPage + offset;
        if (newPage >= 0 && newPage < totalPages) {
            loadJobs(newPage);
        }
    }

    loadJobs();
</script>
</body>
</html>
