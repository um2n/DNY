<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>공고 목록 - Vue.js</title>
    <!-- Vue 3 CDN 추가 (설치 필요 없음) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        li { margin-bottom: 15px; list-style: none; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        button { cursor: pointer; padding: 5px 10px; margin-left: 5px; }
        .filter-box { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .pagination { margin-top: 20px; display: flex; align-items: center; gap: 10px; }
        .bookmarked { background-color: #ffd700; color: black; }
    </style>
</head>
<body>

<div id="app">
    <div style="margin-bottom: 20px;">
        <button @click="goHome">홈으로</button>
        <button @click="goMyPage" style="background-color: #ffc107;">마이페이지(스크랩)</button>
    </div>

    <h2>공고 목록 (Vue.js)</h2>

    <!-- 필터 UI: v-model로 데이터와 실시간 연결 -->
    <div class="filter-box">
        <input type="text" v-model="filters.keyword" placeholder="검색어 (예: 개발, 보안)">
        
        <select v-model="filters.location">
            <option value="">지역 전체</option>
            <option v-for="loc in locations" :key="loc" :value="loc">{{ loc }}</option>
        </select>

        <select v-model="filters.jobType">
            <option value="">채용구분 전체</option>
            <option value="신입">신입</option>
            <option value="인턴">인턴</option>
        </select>

        <select v-model="filters.sort" @change="loadJobs(0)">
            <option value="createdAt,desc">최신 등록순</option>
            <option value="deadline,asc">마감 임박순</option>
        </select>

        <button @click="loadJobs(0)" style="background-color: #007bff; color: white; border: none;">검색</button>
    </div>

    <!-- 공고 목록: v-for로 데이터 반복 출력 -->
    <ul v-if="jobs.length > 0">
        <li v-for="job in jobs" :key="job.jobId">
            <span>
                <strong>{{ job.title }}</strong> ({{ job.company }})
                <span v-if="job.deadline"> [마감: {{ job.deadline }}] </span>
            </span>
            <button 
                :class="{ 'bookmarked': job.bookmarked }"
                @click="toggleBookmark(job)"
            >
                {{ job.bookmarked ? '★ 북마크됨' : '☆ 북마크' }}
            </button>
        </li>
    </ul>
    <p v-else>표시할 공고가 없습니다.</p>

    <!-- 페이징: 데이터 상태에 따라 자동으로 활성/비활성 -->
    <div class="pagination" v-if="totalPages > 0">
        <button :disabled="currentPage === 0" @click="changePage(-1)">이전</button>
        <span>{{ currentPage + 1 }} / {{ totalPages }}</span>
        <button :disabled="currentPage + 1 >= totalPages" @click="changePage(1)">다음</button>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                jobs: [],
                currentPage: 0,
                totalPages: 0,
                locations: ['서울', '경기', '인천', '대전', '대구', '부산', '광주'],
                filters: {
                    keyword: '',
                    location: '',
                    jobType: '',
                    sort: 'createdAt,desc'
                }
            }
        },
        methods: {
            loadJobs(page = 0) {
                this.currentPage = page;
                const { keyword, location, jobType, sort } = this.filters;
                
                let url = `/jobs?page=${page}&size=10&sort=${sort}`;
                if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
                if (location) url += `&location=${encodeURIComponent(location)}`;
                if (jobType) url += `&jobType=${encodeURIComponent(jobType)}`;

                fetch(url, { credentials: "include" })
                    .then(res => {
                        if (res.status === 401) {
                            alert("로그인이 필요합니다.");
                            location.href = "/login.html";
                            return;
                        }
                        return res.json();
                    })
                    .then(response => {
                        if (response && response.success) {
                            this.jobs = response.data.content;
                            this.totalPages = response.data.page.totalPages;
                        }
                    })
                    .catch(err => console.error("로딩 실패:", err));
            },
            toggleBookmark(job) {
                fetch("/bookmark/" + encodeURIComponent(job.jobId), {
                    method: "POST",
                    credentials: "include"
                })
                .then(res => res.json())
                .then(response => {
                    if (response.success) {
                        alert(response.message);
                        // 데이터만 수정하면 화면은 자동으로 바뀜!
                        job.bookmarked = !job.bookmarked;
                    }
                });
            },
            changePage(offset) {
                this.loadJobs(this.currentPage + offset);
            },
            goHome() { location.href = '/index.html'; },
            goMyPage() { location.href = '/mypage.html'; }
        },
        mounted() {
            this.loadJobs();
        }
    }).mount('#app');
</script>
</body>
</html>
